<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightweight IT PM ‚Äî Documents</title>
    <style>
        /* --- General Layout and Dark Theme (Reused from dashboard.html) --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #161b22;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #21262d;
        }

        .logo {
            background-color: #58a6ff;
            color: #0d1117;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 15px;
        }

        h2 {
            font-size: 1.2em;
            margin: 0;
        }

        .project-info {
            font-weight: normal;
            color: #8b949e;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .user-info {
            margin-left: auto;
            font-size: 0.9em;
            color: #8b949e;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-initials {
            background-color: #58a6ff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            margin-left: 8px;
        }
        
        /* --- SIGN OUT BUTTON STYLES --- */
        .signout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .signout-btn:hover {
            background-color: #d32f2f;
        }

        /* --- Sidebar & Main Layout --- */
        .main-layout {
            display: flex;
            height: calc(100vh - 45px);
        }

        .sidebar {
            width: 200px;
            background-color: #161b22;
            padding: 20px 0;
            border-right: 1px solid #21262d;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: #c9d1d9;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .sidebar li a:hover, .sidebar li.active a {
            background-color: #21262d;
            color: #58a6ff;
        }

        .sidebar li.active a {
            border-left: 3px solid #58a6ff;
            padding-left: 17px;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            color: #58a6ff;
            border-bottom: 2px solid #21262d;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        /* --- Docs Specific Styles --- */
        .docs-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .upload-section {
            background-color: #161b22;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #21262d;
            margin-bottom: 30px;
        }

        .upload-form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="file"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #21262d;
            border-radius: 4px;
            background-color: #0d1117;
            color: #c9d1d9;
        }

        .btn-upload {
            background-color: #3fb950; /* Green */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .btn-upload:hover {
            background-color: #2ea043;
        }

        #uploadProgress {
            margin-top: 15px;
            color: #8b949e;
        }

        .document-list-container {
            margin-top: 20px;
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #21262d;
        }

        .document-item:last-child {
            border-bottom: none;
        }

        .document-name {
            font-weight: bold;
            color: #c9d1d9;
            margin-right: 20px;
            flex-grow: 1;
        }

        .document-actions a {
            color: #58a6ff;
            text-decoration: none;
            margin-left: 15px;
            font-weight: bold;
            transition: color 0.2s;
        }
        .document-actions a:hover {
            color: #448aff;
        }
        .document-meta {
            font-size: 0.8em;
            color: #8b949e;
            margin-right: 15px;
        }
        .delete-btn {
            background: none;
            border: none;
            color: #f85149;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            padding: 0;
        }
        .delete-btn:hover {
            text-decoration: underline;
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid #21262d;
            font-size: 0.8em;
            color: #8b949e;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">LP</div>
        <h2>Lightweight IT PM <span class="project-info">‚Äî Project: Capstone</span></h2>

        <div class="user-info">
            <span id="userNameDisplay">Loading...</span>
            <span class="user-initials" id="userInitialsDisplay">?</span>
            <button class="signout-btn" onclick="signOutUser()">Sign Out</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <ul>
                <li><a href="dashboard.html">üè† Dashboard</a></li>
                <li><a href="tasks.html">üóÇ Tasks</a></li>
                <li><a href="timeline.html">üìÖ Timeline</a></li>
                <li><a href="notes.html">üìù Notes</a></li>
                <li class="active"><a href="docs.html">üìé Docs</a></li>
            </ul>
        </div>

        <div class="content">
            <div class="docs-container">
                <h1>üìé Project Documents & Artifacts</h1>

                <div class="upload-section">
                    <h3>Upload New Document</h3>
                    <div class="upload-form">
                        <input type="file" id="fileInput" required>
                        <button class="btn-upload" onclick="uploadFile()">Upload File</button>
                    </div>
                    <div id="uploadProgress">Ready to upload.</div>
                </div>

                <div class="document-list-container">
                    <h3>Available Documents</h3>
                    <div id="documentList">
                        Loading documents...
                    </div>
                </div>

                <div class="footer">
                    <p>¬© Lightweight IT PM ‚Äî Designed for academic teams</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>


    <script>
        // Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUoUZFuxNaUbxMdZyEH4xSle2f0TU_HKg",
            authDomain: "masters-project-kenneth.firebaseapp.com",
            projectId: "masters-project-kenneth",
            storageBucket: "masters-project-kenneth.firebasestorage.app", // IMPORTANT for Storage
            messagingSenderId: "685736871672",
            appId: "1:685736871672:web:179cfc1e9cb361edd49d0d"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize Storage

        let userId = null;
        const DOCUMENTS_COLLECTION = 'projectData/documents';
        
        // DOM Elements
        const userNameDisplay = document.getElementById('userNameDisplay');
        const userInitialsDisplay = document.getElementById('userInitialsDisplay');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const documentList = document.getElementById('documentList');


        // --- AUTHENTICATION & INITIALIZATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                userId = user.uid;

                // Update UI with user info
                userNameDisplay.textContent = user.displayName || user.email;
                userInitialsDisplay.textContent = (user.displayName || user.email).charAt(0).toUpperCase();

                // Load Documents
                loadDocuments();

            } else {
                // No user is signed in. Redirect to login page.
                console.log("No user signed in. Redirecting to login.");
                window.location.href = "index.html";
            }
        });

        function signOutUser() {
            auth.signOut().then(() => {
                localStorage.removeItem("LPM_session");
                localStorage.removeItem("LPM_user_uid");
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Error signing out:", error);
                alert("Error signing out: " + error.message);
            });
        }
        
        // --- UPLOAD FUNCTION ---

        function uploadFile() {
            if (!userId) {
                alert("User not authenticated.");
                return;
            }

            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a file to upload.");
                return;
            }

            // Create a unique storage path: users/{userId}/docs/{timestamp_filename}
            const fileId = new Date().getTime() + '_' + file.name.replace(/[^a-zA-Z0-9.]/g, '_');
            const storageRef = storage.ref(`users/${userId}/docs/${fileId}`);
            
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Observe state change events such as progress, pause, and resume
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgress.textContent = `Upload is ${progress.toFixed(0)}% done`;
                }, 
                (error) => {
                    // Handle unsuccessful uploads
                    console.error("Upload error:", error);
                    uploadProgress.textContent = `Upload failed: ${error.message}`;
                    alert(`Upload failed: ${error.message}`);
                }, 
                () => {
                    // Handle successful uploads on complete
                    uploadProgress.textContent = 'Upload successful! Retrieving URL...';
                    
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        console.log('File available at', downloadURL);

                        // 1. Save file metadata to Firestore
                        db.collection(`users/${userId}/${DOCUMENTS_COLLECTION}`).add({
                            name: file.name,
                            storagePath: `users/${userId}/docs/${fileId}`,
                            downloadURL: downloadURL,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            size: file.size
                        })
                        .then(() => {
                            uploadProgress.textContent = `File "${file.name}" saved successfully.`;
                            fileInput.value = ''; // Clear the input
                            loadDocuments(); // Refresh the list
                        })
                        .catch((e) => {
                            console.error("Error writing document metadata:", e);
                            uploadProgress.textContent = 'Upload successful, but failed to save metadata.';
                        });
                    });
                }
            );
        }

        // --- LISTING & DOWNLOAD FUNCTION ---

        function loadDocuments() {
            if (!userId) return;

            documentList.innerHTML = 'Loading documents...';

            db.collection(`users/${userId}/${DOCUMENTS_COLLECTION}`)
                .orderBy('uploadedAt', 'desc')
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        documentList.innerHTML = 'No documents uploaded yet.';
                        return;
                    }

                    let html = '';
                    snapshot.forEach(doc => {
                        const file = doc.data();
                        const docId = doc.id;
                        const uploadedDate = file.uploadedAt ? file.uploadedAt.toDate().toLocaleDateString() : 'N/A';
                        const fileSize = (file.size / 1024 / 1024).toFixed(2); // Size in MB

                        html += `
                            <div class="document-item" id="doc-${docId}">
                                <span class="document-name">${file.name}</span>
                                <span class="document-meta">${fileSize} MB | Uploaded: ${uploadedDate}</span>
                                <div class="document-actions">
                                    <a href="${file.downloadURL}" target="_blank" download>Download</a>
                                    <button class="delete-btn" onclick="deleteDocument('${docId}', '${file.storagePath}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });

                    documentList.innerHTML = html;
                })
                .catch(error => {
                    console.error("Error loading documents:", error);
                    documentList.innerHTML = 'Error loading document list.';
                });
        }
        
        // --- DELETE FUNCTION ---

        function deleteDocument(docId, storagePath) {
            if (!confirm("Are you sure you want to delete this document?")) return;

            // 1. Delete the file from Firebase Storage
            const fileRef = storage.ref().child(storagePath);

            fileRef.delete().then(() => {
                console.log("File deleted from Storage successfully.");
                
                // 2. Delete the metadata document from Firestore
                return db.collection(`users/${userId}/${DOCUMENTS_COLLECTION}`).doc(docId).delete();
            })
            .then(() => {
                // 3. Update the UI
                document.getElementById(`doc-${docId}`).remove();
                alert("Document successfully deleted.");
            })
            .catch((error) => {
                console.error("Error deleting document:", error);
                alert("Failed to delete document. Check console for details.");
            });
        }
        
    </script>

</body>
</html>
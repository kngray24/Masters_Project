<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightweight IT PM ‚Äî Docs</title>

    <style>
        /* --- Same CSS used in dashboard.html --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #161b22;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #21262d;
        }

        .logo {
            background-color: #58a6ff;
            color: #0d1117;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 15px;
        }

        h2 {
            font-size: 1.2em;
            margin: 0;
        }

        .project-info {
            font-weight: normal;
            color: #8b949e;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .user-info {
            margin-left: auto;
            font-size: 0.9em;
            color: #8b949e;
            display: flex;
            align-items: center;
            gap: 10px; /* Added gap for sign-out button */
        }

        .user-initials {
            background-color: #58a6ff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            margin-left: 8px;
        }

        /* --- SIGN OUT BUTTON STYLES --- */
        .signout-btn {
            background-color: #f44336; /* Red background for sign-out/danger */
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .signout-btn:hover {
            background-color: #d32f2f;
        }

        .main-layout {
            display: flex;
            height: calc(100vh - 45px);
        }

        .sidebar {
            width: 200px;
            background-color: #161b22;
            padding: 20px 0;
            border-right: 1px solid #21262d;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: #c9d1d9;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .sidebar li a:hover,
        .sidebar li.active a {
            background-color: #21262d;
            color: #58a6ff;
        }

        .sidebar li.active a {
            border-left: 3px solid #58a6ff;
            padding-left: 17px;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            color: #58a6ff;
            border-bottom: 2px solid #21262d;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .doc-list {
            list-style: none;
            padding: 0;
        }

        .doc-item {
            background-color: #21262d;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doc-name {
            font-size: 1em;
            color: #c9d1d9;
            flex-grow: 1; /* Allows text to take available space */
            word-break: break-all; /* Breaks long words */
        }

        .doc-uploaded-info {
            font-size: 0.8em;
            color: #8b949e;
            margin-left: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-left: 15px; /* Spacing from doc name */
        }

        .delete-btn, .download-btn {
            background-color: #30363d;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .delete-btn {
            color: #f85149;
        }

        .download-btn {
            color: #58a6ff;
        }

        .delete-btn:hover {
            background-color: #5c2c31;
        }
        .download-btn:hover {
            background-color: #1f3b5a;
        }

        input[type="file"] {
            background-color: #21262d;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .upload-btn {
            margin-top: 10px;
            background-color: #58a6ff;
            border: none;
            padding: 10px 20px;
            color: #0d1117;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .upload-btn:hover {
            background-color: #79b4ff;
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid #21262d;
            font-size: 0.8em;
            color: #8b949e;
        }
        #uploadStatus {
            margin-top: 10px;
            font-size: 0.9em;
            color: #58a6ff;
        }

    </style>
</head>

<body>

    <div class="header">
        <div class="logo">LP</div>
        <h2>Lightweight IT PM <span class="project-info">‚Äî Project: Capstone</span></h2>
        <div class="user-info">
            <span id="userNameDisplay">Loading...</span>
            <span class="user-initials" id="userInitialsDisplay">?</span>
            <button class="signout-btn" onclick="signOutUser()">Sign Out</button>
        </div>
    </div>

    <div class="main-layout">

        <div class="sidebar">
            <ul>
                <li><a href="dashboard.html">üè† Dashboard</a></li>
                <li><a href="tasks.html">üóÇ Tasks</a></li>
                <li><a href="timeline.html">üìÖ Timeline</a></li>
                <li><a href="risk-log.html">‚ö†Ô∏è Risk Log</a></li>
                <li class="active"><a href="docs.html">üìé Docs</a></li>
            </ul>
        </div>

        <div class="content">
            <h1>üìé Project Documents</h1>

            <div class="card">
                <h3>Upload Document</h3>
                <input type="file" id="docFile">
                <button class="upload-btn" onclick="uploadDoc()">Upload</button>
                <div id="uploadStatus" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>Stored Documents</h3>
                <ul class="doc-list" id="docList">
                    <li style="text-align:center;color:#8b949e;" id="loadingDocsMessage">Loading documents...</li>
                    <li style="text-align:center;color:#8b949e; display:none;" id="noDocsMessage">No documents uploaded yet.</li>
                </ul>
            </div>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>

    <script>
        // Your Firebase Configuration - CORRECTED apiKey & VERIFIED storageBucket
        const firebaseConfig = {
            apiKey: "AIzaSyCUoUZFuxNaUbxMdZyEH4xSle2f0TU_HKg", // Corrected likely typo here
            authDomain: "masters-project-kenneth.firebaseapp.com",
            projectId: "masters-project-kenneth",
            storageBucket: "masters-project-kenneth.appspot.com", // Make sure this matches your project's default bucket
            messagingSenderId: "685736871672",
            appId: "1:685736871672:web:179cfc1e9cb361edd49d0d"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully.");
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                alert("Failed to initialize Firebase. Please check your console for errors and ensure your Firebase config is correct.");
            }
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage(); // Initialize Firebase Storage

        let currentUser = null;
        let userId = null;
        let unsubscribeDocs = null; // To hold the unsubscribe function for the docs listener

        const docFile = document.getElementById('docFile');
        const uploadStatus = document.getElementById('uploadStatus');
        const docList = document.getElementById('docList');
        const loadingDocsMessage = document.getElementById('loadingDocsMessage');
        const noDocsMessage = document.getElementById('noDocsMessage');


        // --- AUTHENTICATION CHECK ---
        auth.onAuthStateChanged(user => {
            console.log("onAuthStateChanged fired. User:", user); // Log the user object
            if (user) {
                currentUser = user;
                userId = user.uid;
                console.log("User is authenticated:", user.uid);

                document.getElementById('userNameDisplay').textContent = user.displayName || user.email;
                document.getElementById('userInitialsDisplay').textContent = (user.displayName || user.email).charAt(0).toUpperCase();

                setupDocListener(); // Start listening for documents
            } else {
                console.log("No user signed in. Redirecting to login.");
                window.location.href = "index.html";
            }
        });

        function signOutUser() {
            auth.signOut().then(() => {
                console.log("User signed out successfully.");
                localStorage.removeItem("LPM_session");
                localStorage.removeItem("LPM_user_uid");
                if (unsubscribeDocs) {
                    unsubscribeDocs();
                }
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Error signing out:", error);
                alert("Error signing out: " + error.message);
            });
        }

        // --- FIRESTORE / CLOUD STORAGE OPERATIONS ---

        function setupDocListener() {
            if (!userId) {
                console.error("User ID not available for document listener. Listener not set up.");
                return;
            }
            console.log("Setting up document listener for user:", userId);

            if (unsubscribeDocs) {
                console.log("Unsubscribing from previous document listener.");
                unsubscribeDocs();
            }

            loadingDocsMessage.style.display = 'block';
            noDocsMessage.style.display = 'none';
            docList.innerHTML = ''; // Clear previous items

            unsubscribeDocs = db.collection(`users/${userId}/documents`)
                .orderBy("uploadedAt", "desc") // Newest first
                .onSnapshot(snapshot => {
                    console.log("Received new document snapshot.");
                    const documents = snapshot.docs.map(doc => ({
                        id: doc.id, // Firestore document ID
                        ...doc.data()
                    }));
                    renderDocs(documents);
                    loadingDocsMessage.style.display = 'none'; // Hide loading message
                }, error => {
                    console.error("Error fetching documents:", error);
                    docList.innerHTML = '<li style="text-align:center;color:#f85149;">Error loading documents.</li>';
                    loadingDocsMessage.style.display = 'none';
                });
        }

        function renderDocs(documents) {
            docList.innerHTML = '';

            if (documents.length === 0) {
                noDocsMessage.style.display = 'block';
                return;
            }

            documents.forEach(doc => {
                const item = document.createElement('li');
                item.classList.add('doc-item');

                // Format uploaded date
                const uploadedDate = doc.uploadedAt ? doc.uploadedAt.toDate().toLocaleDateString() : 'N/A';
                const uploadedBy = doc.uploadedBy || 'Unknown';

                item.innerHTML = `
                    <span class="doc-name">${doc.name}</span>
                    <span class="doc-uploaded-info">Uploaded by ${uploadedBy} on ${uploadedDate}</span>
                    <div class="btn-group">
                        <button class="download-btn" onclick="downloadDoc('${doc.id}', '${doc.downloadURL}', '${doc.name}')">Download</button>
                        <button class="delete-btn" onclick="deleteDoc('${doc.id}', '${doc.fullPath}')">Delete</button>
                    </div>
                `;
                docList.appendChild(item);
            });
        }

        async function uploadDoc() {
            const file = docFile.files[0];

            if (!file) {
                alert("Please select a file to upload.");
                return;
            }

            uploadStatus.style.display = 'block';
            uploadStatus.style.color = '#58a6ff'; // Blue for info/progress
            uploadStatus.textContent = 'Uploading...';

            const uniqueFileName = `${Date.now()}_${file.name}`;
            const filePath = `users/${userId}/documents/${uniqueFileName}`; // Path in Cloud Storage
            const storageRef = storage.ref(filePath);
            const uploadTask = storageRef.put(file);

            uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadStatus.textContent = `Upload is ${progress.toFixed(0)}% done`;
                },
                (error) => {
                    console.error("Upload error:", error);
                    uploadStatus.style.color = '#f85149'; // Red for error
                    uploadStatus.textContent = `Upload failed: ${error.message}`;
                    alert("Upload failed: " + error.message);
                },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
                        try {
                            await db.collection(`users/${userId}/documents`).add({
                                name: file.name, // Store original file name
                                uniqueFileName: uniqueFileName, // Store unique name in storage
                                fullPath: filePath, // Store full path for deletion from Storage
                                downloadURL: downloadURL,
                                uploadedBy: currentUser.displayName || currentUser.email,
                                uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            uploadStatus.style.color = '#3fb950'; // Green for success
                            uploadStatus.textContent = 'Upload successful!';
                            docFile.value = ''; // Clear file input
                            setTimeout(() => { uploadStatus.style.display = 'none'; }, 3000); // Hide status after 3 seconds
                        } catch (error) {
                            console.error("Error saving document metadata:", error);
                            uploadStatus.style.color = '#f85149';
                            uploadStatus.textContent = `Upload successful, but failed to save metadata: ${error.message}`;
                        }
                    });
                }
            );
        }

        window.downloadDoc = (docId, downloadURL, fileName) => {
            if (downloadURL) {
                const link = document.createElement("a");
                link.href = downloadURL;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("Download URL not available.");
            }
        };

        window.deleteDoc = async (firestoreDocId, storageFullPath) => {
            if (confirm(`Are you sure you want to delete this document?`)) {
                try {
                    // 1. Delete file from Cloud Storage
                    const fileRef = storage.ref(storageFullPath);
                    await fileRef.delete();
                    console.log("File deleted from Cloud Storage:", storageFullPath);

                    // 2. Delete metadata from Firestore
                    await db.collection(`users/${userId}/documents`).doc(firestoreDocId).delete();
                    console.log("Metadata deleted from Firestore:", firestoreDocId);

                    alert("Document deleted successfully!");
                } catch (error) {
                    console.error("Error deleting document:", error);
                    // Specific check for 'storage/object-not-found'
                    if (error.code === 'storage/object-not-found') {
                        alert("Failed to delete file from storage (it might already be gone). Deleting metadata.");
                        // Proceed to delete metadata if file was already missing
                        try {
                            await db.collection(`users/${userId}/documents`).doc(firestoreDocId).delete();
                            console.log("Metadata deleted from Firestore after Storage file not found:", firestoreDocId);
                        } catch (metadataError) {
                             console.error("Failed to delete metadata after storage error:", metadataError);
                             alert("Failed to delete metadata: " + metadataError.message);
                        }
                    } else {
                        alert("Failed to delete document: " + error.message);
                    }
                }
            }
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightweight IT PM ‚Äî Timeline</title>
    <style>
        /* --- General Layout and Dark Theme (for consistency) --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #161b22;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #21262d;
        }

        .logo {
            background-color: #58a6ff;
            color: #0d1117;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 15px;
        }

        h2 {
            font-size: 1.2em;
            margin: 0;
        }

        .project-info {
            font-weight: normal;
            color: #8b949e;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .user-info {
            margin-left: auto;
            font-size: 0.9em;
            color: #8b949e;
            display: flex;
            align-items: center;
            gap: 10px; /* Added gap for sign-out button */
        }

        .user-initials {
            background-color: #58a6ff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            margin-left: 8px;
        }

        /* --- SIGN OUT BUTTON STYLES --- */
        .signout-btn { /* Changed class name for consistency with other pages */
            background-color: #f44336; /* Red background for sign-out/danger */
            color: white;
            border: none;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .signout-btn:hover {
            background-color: #d32f2f;
        }

        /* --- Sidebar & Main Layout --- */
        .main-layout {
            display: flex;
            height: calc(100vh - 45px); /* Full viewport height minus header */
        }

        .sidebar {
            width: 200px;
            background-color: #161b22;
            padding: 20px 0;
            border-right: 1px solid #21262d;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: #c9d1d9;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .sidebar li a:hover, .sidebar li.active a {
            background-color: #21262d;
            color: #58a6ff;
        }

        .sidebar li.active a {
            border-left: 3px solid #58a6ff;
            padding-left: 17px;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            color: #58a6ff;
            border-bottom: 2px solid #21262d;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* --- Timeline Specific Styles (omitted for brevity, assume they are the same) --- */
        /* ... (Keep all your existing Timeline CSS here) ... */


        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters button {
            padding: 8px 15px;
            margin-right: 10px;
            background-color: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .filters button:hover, .filters button.active {
            background-color: #30363d;
        }

        #addEventButton {
            padding: 10px 15px;
            background-color: #238636;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #addEventButton:hover {
            background-color: #2ea043;
        }

        /* Event Form Styling */
        #eventForm {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
        }

        #eventForm input[type="text"], #eventForm input[type="date"], #eventForm select {
            padding: 10px;
            border: 1px solid #30363d;
            border-radius: 4px;
            background-color: #0d1117;
            color: #c9d1d9;
            width: 100%;
            box-sizing: border-box;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .save-button, .cancel-button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .save-button {
            background-color: #58a6ff;
            color: white;
        }

        .cancel-button {
            background-color: #30363d;
            color: #c9d1d9;
        }

        /* Gantt-style Roadmap */
        .roadmap-container {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
        }

        .roadmap-header {
            display: flex;
            font-weight: bold;
            color: #8b949e;
            padding-bottom: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid #21262d;
        }

        .roadmap-header div {
            flex: 1;
            text-align: center;
        }

        .roadmap-header .event-name {
            text-align: left;
            flex-basis: 150px;
            flex-grow: 0;
            padding-right: 10px;
        }

        .roadmap-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #21262d;
        }

        .roadmap-row:last-child {
            border-bottom: none;
        }

        .roadmap-event-name {
            flex-basis: 150px;
            flex-grow: 0;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }

        .roadmap-chart {
            flex-grow: 1;
            display: flex;
            align-items: center;
            height: 20px;
            background-color: #0d1117;
            border-radius: 3px;
            padding: 0 5px;
        }

        .timeline-bar {
            height: 10px;
            border-radius: 2px;
            background-color: #58a6ff; /* Default */
            position: relative;
            font-size: 0.7em;
            color: white;
            text-align: right;
            line-height: 10px;
            padding-right: 5px;
            transition: width 0.5s;
        }

        .timeline-bar.current { background-color: #d29922; }
        .timeline-bar.complete { background-color: #3fb950; }
        .timeline-bar.upcoming { background-color: #58a6ff; }

        /* Event List */
        .event-list {
            list-style: none;
            padding: 0;
        }

        .event-item {
            background-color: #21262d;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            line-height: 1.4;
        }

        .event-item.upcoming { border-left-color: #58a6ff; }
        .event-item.current { border-left-color: #d29922; }
        .event-item.complete { border-left-color: #3fb950; opacity: 0.7; }

        .event-details-text {
            flex-grow: 1;
        }

        .event-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #c9d1d9;
        }

        .event-dates {
            font-size: 0.9em;
            color: #8b949e;
        }

        .event-actions button {
            background: none;
            border: none;
            color: #58a6ff;
            cursor: pointer;
            font-size: 1em;
            margin-left: 15px;
            transition: color 0.2s;
        }

        .event-actions .delete-button {
            color: #f85149;
        }

        .event-actions button:hover {
            color: #8b949e;
        }


        .footer {
            margin-top: 40px;
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid #21262d;
            font-size: 0.8em;
            color: #8b949e;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="logo">LP</div>
        <h2>Lightweight IT PM <span class="project-info">‚Äî Project: Capstone</span></h2>

        <div class="user-info">
            <span id="userNameDisplay">Loading...</span>
            <span class="user-initials" id="userInitialsDisplay">?</span>
            <button class="signout-btn" onclick="signOutUser()">Sign Out</button>
        </div>
    </div>

    <div class="main-layout">
        <div class="sidebar">
            <ul>
                <li><a href="dashboard.html">üè† Dashboard</a></li>
                <li><a href="tasks.html">üóÇ Tasks</a></li>
                <li class="active"><a href="timeline.html">üìÖ Timeline</a></li>
                <li><a href="risk-log.html">‚ö†Ô∏è Risk Log</a></li>
                <li><a href="docs.html">üìé Docs</a></li>
            </ul>
        </div>

        <div class="content">
            <h1>üìÖ Project Timeline & Schedule</h1>

            <div class="controls">
                <div class="filters">
                    <button class="active">View Month</button>
                    <button>Filter: Milestones</button>
                </div>
                <button id="addEventButton">+ Add Event</button>
            </div>

            <div id="eventForm">
                <input type="hidden" id="editEventId"> <!-- Changed from editEventIndex -->
                <input type="text" id="eventTitle" placeholder="Event/Phase Title" required>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="eventStartDate" required style="width: 50%;">
                    <input type="date" id="eventEndDate" required style="width: 50%;">
                </div>
                <select id="eventStatus" required>
                    <option value="upcoming">Upcoming</option>
                    <option value="current">In Progress</option>
                    <option value="complete">Complete</option>
                </select>
                <div class="form-actions">
                    <button id="cancelButton" class="cancel-button">Cancel</button>
                    <button id="saveEventButton" class="save-button">Save Event</button>
                </div>
            </div>

            <h2>Detailed Project Roadmap (Gantt View)</h2>
            <div class="roadmap-container">
                <div class="roadmap-header">
                    <div class="event-name">Event/Phase</div>
                    <div>Week 1</div>
                    <div>Week 2</div>
                    <div>Week 3</div>
                    <div>Week 4</div>
                    <div>Week 5</div>
                    <div>Week 6</div>
                    <div>Week 7</div>
                    <div>Week 8</div>
                </div>
                <div id="roadmapChart">
                    <div class="roadmap-row" id="default-roadmap-row" style="text-align: center; padding: 20px; color: #8b949e;">
                        Loading timeline...
                    </div>
                </div>
            </div>

            <h2>All Events List</h2>
            <ul class="event-list" id="eventList">
                <li style="text-align:center;color:#8b949e;">Loading events...</li>
            </ul>

            <div class="footer">
                <p>¬© Lightweight IT PM ‚Äî Designed for academic teams</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // Your Firebase Configuration (make sure this is correct from your Project Settings)
        const firebaseConfig = {
            apiKey: "AIzaSyCUoUZFuxNaUbxMdZyEH4xSle2f0TU_HKg",
            authDomain: "masters-project-kenneth.firebaseapp.com",
            projectId: "masters-project-kenneth",
            storageBucket: "masters-project-kenneth.firebasestorage.app",
            messagingSenderId: "685736871672",
            appId: "1:685736871672:web:179cfc1e9cb361edd49d0d"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userId = null;
        let unsubscribeEvents = null; // To hold the unsubscribe function for the events listener

        const addEventButton = document.getElementById('addEventButton');
        const eventForm = document.getElementById('eventForm');
        const saveEventButton = document.getElementById('saveEventButton');
        const cancelButton = document.getElementById('cancelButton');
        const eventList = document.getElementById('eventList');
        const roadmapChart = document.getElementById('roadmapChart');
        const editEventIdInput = document.getElementById('editEventId'); // Changed from editEventIndex
        const defaultRoadmapRow = document.getElementById('default-roadmap-row');

        // Form Inputs
        const eventTitleInput = document.getElementById('eventTitle');
        const eventStartDateInput = document.getElementById('eventStartDate');
        const eventEndDateInput = document.getElementById('eventEndDate');
        const eventStatusInput = document.getElementById('eventStatus');

        // --- AUTHENTICATION CHECK ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in.
                currentUser = user;
                userId = user.uid;

                // Update UI with user info
                document.getElementById('userNameDisplay').textContent = user.displayName || user.email;
                document.getElementById('userInitialsDisplay').textContent = (user.displayName || user.email).charAt(0).toUpperCase();

                // Start listening for events once user is authenticated
                setupEventListener();

            } else {
                // No user is signed in. Redirect to login page.
                console.log("No user signed in. Redirecting to login.");
                window.location.href = "index.html";
            }
        });

        function signOutUser() {
            auth.signOut().then(() => {
                localStorage.removeItem("LPM_session");
                localStorage.removeItem("LPM_user_uid");
                if (unsubscribeEvents) {
                    unsubscribeEvents();
                }
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Error signing out:", error);
                alert("Error signing out: " + error.message);
            });
        }

        // --- FIRESTORE EVENT OPERATIONS ---

        function setupEventListener() {
            if (!userId) {
                console.error("User ID not available for event listener.");
                return;
            }

            if (unsubscribeEvents) {
                unsubscribeEvents();
            }

            // Real-time listener for events, ordered by start date
            unsubscribeEvents = db.collection(`users/${userId}/events`)
                .orderBy("start", "asc")
                .onSnapshot(snapshot => {
                    // Map Firestore documents to a cleaner array of objects
                    const fetchedEvents = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // Convert Firestore Timestamps to ISO date strings for input fields
                        start: doc.data().start ? doc.data().start.toDate().toISOString().split('T')[0] : '',
                        end: doc.data().end ? doc.data().end.toDate().toISOString().split('T')[0] : '',
                    }));
                    renderTimeline(fetchedEvents); // Render both list and roadmap
                }, error => {
                    console.error("Error fetching events:", error);
                    eventList.innerHTML = '<li style="text-align:center;color:#f85149;">Error loading events.</li>';
                    roadmapChart.innerHTML = '<div class="roadmap-row" style="text-align: center; padding: 20px; color: #f85149;">Error loading roadmap.</div>';
                });
        }

        // Helper function to convert date string to Date object
        const parseDate = (dateString) => new Date(dateString);

        // Helper function to calculate duration in days
        const calculateDurationDays = (start, end) => {
            const startDate = parseDate(start);
            const endDate = parseDate(end);
            const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
            // Add 1 day to include the end date
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        };

        // Helper function to show/hide the form and reset state
        function toggleForm(show = true, eventData = null) {
            if (show) {
                eventForm.style.display = 'flex';
                addEventButton.style.display = 'none';

                if (eventData) { // Editing an existing event
                    editEventIdInput.value = eventData.id;
                    eventTitleInput.value = eventData.title;
                    eventStartDateInput.value = eventData.start;
                    eventEndDateInput.value = eventData.end;
                    eventStatusInput.value = eventData.status;
                } else { // Adding a new event
                    editEventIdInput.value = '';
                    eventTitleInput.value = '';
                    eventStartDateInput.value = '';
                    eventEndDateInput.value = '';
                    eventStatusInput.value = 'upcoming';
                }
            } else { // Hiding the form
                eventForm.style.display = 'none';
                addEventButton.style.display = 'block';
                // Reset form fields completely
                editEventIdInput.value = '';
                eventTitleInput.value = '';
                eventStartDateInput.value = '';
                eventEndDateInput.value = '';
                eventStatusInput.value = 'upcoming';
            }
        }

        // --- RENDER ALL TIMELINE COMPONENTS ---
        function renderTimeline(events) {
            renderEventList(events);
            renderRoadmap(events);
        }

        // --- RENDER ROADMAP ---
        function renderRoadmap(events) {
            roadmapChart.innerHTML = ''; // Clear the chart

            if (events.length === 0) {
                defaultRoadmapRow.style.display = 'block';
                defaultRoadmapRow.textContent = 'No events added yet.';
                return;
            }

            defaultRoadmapRow.style.display = 'none';

            // Determine the overall timeline range (fixed 8 weeks from current date)
            const today = new Date();
            // Start of the current week (Monday)
            const projectStart = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
            projectStart.setHours(0, 0, 0, 0); // Normalize to start of day
            const totalTimelineDays = 8 * 7; // 8 weeks

            events.forEach(event => {
                const startDate = parseDate(event.start);
                const endDate = parseDate(event.end);

                // Calculate position (offset) and width (duration) relative to projectStart
                let offsetDays = Math.floor((startDate.getTime() - projectStart.getTime()) / (1000 * 60 * 60 * 24));
                let durationDays = calculateDurationDays(event.start, event.end);

                // Skip event if it's completely outside the 8-week window
                if (endDate.getTime() < projectStart.getTime() || startDate.getTime() > (projectStart.getTime() + totalTimelineDays * 24 * 60 * 60 * 1000)) {
                    return;
                }

                // Adjust offset and duration if event starts before or ends after the 8-week window
                if (offsetDays < 0) {
                    durationDays += offsetDays; // Subtract days that are before projectStart
                    offsetDays = 0;
                }
                if (offsetDays + durationDays > totalTimelineDays) {
                    durationDays = totalTimelineDays - offsetDays;
                }

                if (durationDays <= 0) return; // Don't render if duration becomes zero or negative after clipping

                // Convert days to percentage of the total 8-week timeline
                const offsetPercent = (offsetDays / totalTimelineDays) * 100;
                const widthPercent = (durationDays / totalTimelineDays) * 100;

                const row = document.createElement('div');
                row.classList.add('roadmap-row');
                row.innerHTML = `
                    <div class="roadmap-event-name" title="${event.title}">${event.title}</div>
                    <div class="roadmap-chart">
                        <div class="timeline-bar ${event.status}" style="margin-left: ${offsetPercent}%; width: ${widthPercent}%;">
                            ${durationDays > 3 ? `${durationDays} Days` : ''} <!-- Show days only if bar is wide enough -->
                        </div>
                    </div>
                `;
                roadmapChart.appendChild(row);
            });
        }


        // --- RENDER EVENT LIST ---
        function renderEventList(events) { // Takes events array as argument
            eventList.innerHTML = '';

            if (events.length === 0) {
                eventList.innerHTML = '<p style="text-align:center;color:#8b949e;">No events yet.</p>';
                return;
            }

            events.forEach(event => {
                const listItem = document.createElement('li');
                listItem.classList.add('event-item', event.status);

                const durationDays = calculateDurationDays(event.start, event.end);

                listItem.innerHTML = `
                    <div class="event-details-text">
                        <div class="event-title">${event.title} (${durationDays} Days)</div>
                        <div class="event-dates">${event.start} ‚Äî ${event.end} (${event.status.charAt(0).toUpperCase() + event.status.slice(1)})</div>
                    </div>
                    <div class="event-actions">
                        <button onclick="editEvent('${event.id}')">‚úèÔ∏è Edit</button>
                        <button class="delete-button" onclick="deleteEvent('${event.id}')">üóëÔ∏è Delete</button>
                    </div>
                `;
                eventList.appendChild(listItem);
            });
        }

        // --- CRUD LOGIC ---

        async function saveEvent() {
            const title = eventTitleInput.value.trim();
            const start = eventStartDateInput.value;
            const end = eventEndDateInput.value;
            const status = eventStatusInput.value;
            const eventId = editEventIdInput.value;

            if (!title || !start || !end) {
                alert("Please fill in Title, Start Date, and End Date.");
                return;
            }

            // Basic date validation
            if (parseDate(start) > parseDate(end)) {
                alert("The End Date cannot be before the Start Date.");
                return;
            }

            const eventData = {
                title: title,
                // Convert date strings to Firestore Timestamps
                start: firebase.firestore.Timestamp.fromDate(new Date(start)),
                end: firebase.firestore.Timestamp.fromDate(new Date(end)),
                status: status
            };

            try {
                if (eventId) {
                    // Update existing event
                    await db.collection(`users/${userId}/events`).doc(eventId).update(eventData);
                } else {
                    // Add new event
                    await db.collection(`users/${userId}/events`).add({
                        ...eventData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() // For initial sorting
                    });
                }
                toggleForm(false); // Hide and reset form
            } catch (error) {
                console.error("Error saving event:", error);
                alert("Failed to save event: " + error.message);
            }
        }

        window.editEvent = async (eventId) => {
            try {
                const doc = await db.collection(`users/${userId}/events`).doc(eventId).get();
                if (doc.exists) {
                    // Pass the data including id to toggleForm
                    toggleForm(true, {
                        id: doc.id,
                        ...doc.data(),
                        // Convert Firestore Timestamps to ISO date strings for input fields
                        start: doc.data().start.toDate().toISOString().split('T')[0],
                        end: doc.data().end.toDate().toISOString().split('T')[0]
                    });
                } else {
                    console.warn("Event not found for editing:", eventId);
                }
            } catch (error) {
                console.error("Error fetching event for edit:", error);
                alert("Failed to load event for editing: " + error.message);
            }
        };

        window.deleteEvent = async (eventId) => {
            if (confirm(`Are you sure you want to delete this event?`)) {
                try {
                    await db.collection(`users/${userId}/events`).doc(eventId).delete();
                } catch (error) {
                    console.error("Error deleting event:", error);
                    alert("Failed to delete event: " + error.message);
                }
            }
        };

        // --- EVENT LISTENERS ---
        addEventButton.addEventListener('click', () => toggleForm(true));
        saveEventButton.addEventListener('click', saveEvent);
        cancelButton.addEventListener('click', () => toggleForm(false));

        // Initial rendering is handled by the Firestore listener once authenticated
    </script>

</body>
</html>
